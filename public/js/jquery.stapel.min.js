(function(g,h,e){var a=g.event,b,j;b=a.special.debouncedresize={setup:function(){g(this).on("resize",b.handler)},teardown:function(){g(this).off("resize",b.handler)},handler:function(o,k){var n=this,m=arguments,l=function(){o.type="debouncedresize";a.dispatch.apply(n,m)};if(j){clearTimeout(j)}k?l():j=setTimeout(l,b.threshold)},threshold:150};var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";g.fn.imagesLoaded=function(r){var o=this,t=g.isFunction(g.Deferred)?g.Deferred():0,s=g.isFunction(t.notify),l=o.find("img").add(o.filter("img")),m=[],q=[],n=[];if(g.isPlainObject(r)){g.each(r,function(u,v){if(u==="callback"){r=v}else{if(t){t[u](v)}}})}function p(){var u=g(q),v=g(n);if(t){if(n.length){t.reject(l,u,v)}else{t.resolve(l)}}if(g.isFunction(r)){r.call(o,l,u,v)}}function k(u,v){if(u.src===c||g.inArray(u,m)!==-1){return}m.push(u);if(v){n.push(u)}else{q.push(u)}g.data(u,"imagesLoaded",{isBroken:v,src:u.src});if(s){t.notifyWith(g(u),[v,l,g(q),g(n)])}if(l.length===m.length){setTimeout(p);l.unbind(".imagesLoaded")}}if(!l.length){p()}else{l.bind("load.imagesLoaded error.imagesLoaded",function(u){k(u.target,u.type==="error")}).each(function(u,w){var x=w.src;var v=g.data(w,"imagesLoaded");if(v&&v.src===x){k(w,v.isBroken);return}if(w.complete&&w.naturalWidth!==e){k(w,w.naturalWidth===0||w.naturalHeight===0);return}if(w.readyState||w.complete){w.src=c;w.src=x}})}return t?t.promise(o):o};var d=g(h),f=h.Modernizr;g.Stapel=function(k,l){this.el=g(l);this._init(k)};g.Stapel.defaults={gutter:40,pileAngles:2,pileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:400,closeEasing:"ease-in-out"},otherPileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:350,closeEasing:"ease-in-out"},delay:0,randomAngle:false,onLoad:function(){return false},onBeforeOpen:function(k){return false},onAfterOpen:function(k,l){return false},onBeforeClose:function(k){return false},onAfterClose:function(k,l){return false}};g.Stapel.prototype={_init:function(l){this.options=g.extend(true,{},g.Stapel.defaults,l);this._config();var k=this;this.el.imagesLoaded(function(){k.options.onLoad();k._layout();k._initEvents()})},_config:function(){this.support=f.csstransitions;var k={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},l={WebkitTransform:"-webkit-transform",MozTransform:"-moz-transform",OTransform:"-o-transform",msTransform:"-ms-transform",transform:"transform"};if(this.support){this.transEndEventName=k[f.prefixed("transition")]+".cbpFWSlider";this.transformName=l[f.prefixed("transform")]}this.spread=false;this.items=this.el.children("li").hide();this.close=g("#tp-close")},_getSize:function(){this.elWidth=this.el.outerWidth(true)},_initEvents:function(){var k=this;d.on("debouncedresize.stapel",function(){k._resize()});this.items.on("click.stapel",function(){var l=g(this);if(!k.spread&&l.data("isPile")){k.spread=true;k.pileName=l.data("pileName");k.options.onBeforeOpen(k.pileName);k._openPile();return false}})},_layout:function(){this._piles();this.itemSize={width:this.items.outerWidth(true),height:this.items.outerHeight(true)};this.items.remove();this._setInitialStyle();this.el.css("min-width",this.itemSize.width+this.options.gutter);this._getSize();this._setItemsPosition();this.items=this.el.children("li").show();this.itemsCount=this.items.length},_piles:function(){this.piles={};var m,l=this,k=0;this.items.each(function(){var p=g(this),o=p.attr("data-pile")||"nopile-"+p.index(),n=o.split(",");for(var q=0,s=n.length;q<s;++q){var r=g.trim(n[q]);m=l.piles[r];if(!m){m=l.piles[r]={elements:[],position:{left:0,top:0},index:k};++k}var t=p.clone().get(0);m.elements.push({el:t,finalPosition:{left:0,top:0}});g(t).appendTo(l.el)}})},_setInitialStyle:function(){for(var o in this.piles){var r=this.piles[o];for(var m=0,k=r.elements.length;m<k;++m){var l=g(r.elements[m].el),n={transform:"rotate(0deg)"};this._applyInitialTransition(l);if(m===k-2){n={transform:"rotate("+this.options.pileAngles+"deg)"}}else{if(m===k-3){n={transform:"rotate(-"+this.options.pileAngles+"deg)"}}else{if(m!==k-1){var q={visibility:"hidden"};l.css(q).data("extraStyle",q)}else{if(o.substr(0,6)!=="nopile"){l.data("front",true).append('<div class="tp-title"><span>'+o+"</span><span>"+k+"</span></div>")}}}}l.css(n).data({initialStyle:n,pileName:o,pileCount:k,shadow:l.css("box-shadow"),isPile:o.substr(0,6)==="nopile"?false:true})}}},_applyInitialTransition:function(k){if(this.support){k.css("transition","left 400ms ease-in-out, top 400ms ease-in-out")}},_setItemsPosition:function(){var D=0,x=0,w,s,A=0,k=0;for(var q in this.piles){var u=this.piles[q],o=this.itemSize.width+this.options.gutter,C=0,v=0,r,m;if(D+o<=this.elWidth){w=D;s=x;D+=o}else{if(A===0){A=Math.ceil((this.elWidth-D+this.options.gutter)/2)}x+=this.itemSize.height+this.options.gutter;w=0;s=x;D=o}u.position.left=w;u.position.top=s;for(var y=0,z=u.elements.length;y<z;++y){var B=u.elements[y],n=B.finalPosition;if(C+o<=this.elWidth){r=C;m=v;C+=o}else{v+=this.itemSize.height+this.options.gutter;r=0;m=v;C=o}n.left=r;n.top=m;var E=g(B.el);if(q!==this.pileName){E.css({left:u.position.left,top:u.position.top})}else{k=B.finalPosition.top;E.css({left:B.finalPosition.left,top:k})}}}k=this.spread?k:x;this.el.css({marginLeft:A,height:k+this.itemSize.height})},_openPile:function(){if(!this.spread){return false}var q;for(var t in this.piles){var l=this.piles[t],m=0;for(var o=0,r=l.elements.length;o<r;++o){var n=l.elements[o],u=g(n.el),k=u.find("img"),s=t===this.pileName?{zIndex:9999,visibility:"visible",transition:this.support?"left "+this.options.pileAnimation.openSpeed+"ms "+((r-o-1)*this.options.delay)+"ms "+this.options.pileAnimation.openEasing+", top "+this.options.pileAnimation.openSpeed+"ms "+((r-o-1)*this.options.delay)+"ms "+this.options.pileAnimation.openEasing+", "+this.transformName+" "+this.options.pileAnimation.openSpeed+"ms "+((r-o-1)*this.options.delay)+"ms "+this.options.pileAnimation.openEasing:"none"}:{zIndex:1,transition:this.support?"opacity "+this.options.otherPileAnimation.closeSpeed+"ms "+this.options.otherPileAnimation.closeEasing:"none"};if(t===this.pileName){if(u.data("front")){u.find("div.tp-title").hide()}if(o<r-1){k.css("visibility","visible")}q=n.finalPosition;q.transform=this.options.randomAngle&&o!==l.index?"rotate("+Math.floor(Math.random()*(5+5+1)-5)+"deg)":"none";if(!this.support){u.css("transform","none")}if(o<r-3){u.css("box-shadow","none")}}else{if(o<r-1){k.css("visibility","hidden")}}u.css(s);var v=this;t===this.pileName?this._applyTransition(u,q,this.options.pileAnimation.openSpeed,function(p){var x=this.target||this.nodeName;if(x!=="LI"){return}var w=g(this);w.css("box-shadow",w.data("shadow"));if(v.support){w.off(v.transEndEventName)}++m;if(m===w.data("pileCount")){g(document).one("mousemove.stapel",function(){v.el.addClass("tp-open")});v.options.onAfterOpen(v.pileName,m)}}):this._applyTransition(u,{opacity:0},this.options.otherPileAnimation.closeSpeed)}}this.el.css("height",q.top+this.itemSize.height)},_closePile:function(){var t=this;if(this.spread){this.spread=false;this.options.onBeforeClose(this.pileName);this.el.removeClass("tp-open");var n;for(var r in this.piles){var k=this.piles[r],l=0;for(var m=0,o=k.elements.length;m<o;++m){var s=g(k.elements[m].el),q=r===this.pileName?{transition:this.support?"left "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", top "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", "+this.transformName+" "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing:"none"}:{transition:this.support?"opacity "+this.options.otherPileAnimation.openSpeed+"ms "+this.options.otherPileAnimation.openEasing:"none"};s.css(q);n=k.position;if(r===this.pileName){g.extend(n,s.data("initialStyle"));if(m<o-3){s.css("box-shadow","none")}}r===this.pileName?this._applyTransition(s,n,this.options.pileAnimation.closeSpeed,function(p){var w=this.target||this.nodeName;if(w!=="LI"){return}var u=g(this),v=u.data("extraStyle");u.css("box-shadow",u.data("shadow"));if(t.support){u.off(t.transEndEventName);t._applyInitialTransition(u)}else{u.css(u.data("initialStyle"))}if(v){u.css(v)}++l;if(u.data("front")){u.find("div.tp-title").show()}if(l===u.data("pileCount")){t.options.onAfterClose(u.data("pileName"),l)}}):this._applyTransition(s,{opacity:1},this.options.otherPileAnimation.openSpeed,function(p){var v=this.target||this.nodeName;if(v!=="LI"){return}var u=g(this);if(u.index()<o-1){u.find("img").css("visibility","visible")}if(t.support){u.off(t.transEndEventName);t._applyInitialTransition(u)}})}}this.pileName="";this.el.css("height",n.top+this.itemSize.height)}return false},_resize:function(){this._getSize();this._setItemsPosition()},_applyTransition:function(l,k,m,n){g.fn.applyStyle=this.support?g.fn.css:g.fn.animate;if(n&&this.support){l.on(this.transEndEventName,n)}n=n||function(){return false};l.stop().applyStyle(k,g.extend(true,[],{duration:m+"ms",complete:n}))},closePile:function(){this._closePile()}};var i=function(k){if(h.console){h.console.error(k)}};g.fn.stapel=function(m){var k=g.data(this,"stapel");if(typeof m==="string"){var l=Array.prototype.slice.call(arguments,1);this.each(function(){if(!k){i("cannot call methods on stapel prior to initialization; attempted to call method '"+m+"'");return}if(!g.isFunction(k[m])||m.charAt(0)==="_"){i("no such method '"+m+"' for stapel instance");return}k[m].apply(k,l)})}else{this.each(function(){if(k){k._init()}else{k=g.data(this,"stapel",new g.Stapel(m,this))}})}return k}})(jQuery,window);